/**
 * @file transformedconslaw_test.cc
 * @brief NPDE exam problem
 * @author Oliver Rietmann
 * @date 04.08.2021
 * @copyright Developed at SAM, ETH Zurich
 */

#include "../transformedconslaw.h"

#include <gtest/gtest.h>

#include <Eigen/Core>
#include <cmath>
#include <utility>

namespace TRFCL::test {

const static Eigen::IOFormat CSVFormat(Eigen::FullPrecision,
                                       Eigen::DontAlignCols, ", ", "\n");

TEST(TRFCL, rhoInverse) {
  double u = 2.0;
  double z0 = 1.0;

  double z =
      rhoInverse<double(double), double(double)>(u, z0, std::exp, std::exp);

  double tol = 1.0e-6;
  ASSERT_NEAR(z, M_LN2, tol);
}

TEST(TRFCL, semiDiscreteRhs) {
  NonStdCauchyProblemCL prb;
  int N = 500;

  // Compute cell points and inital data for plot
  std::pair<double, double> limits = prb.domain();
  Eigen::VectorXd x =
      Eigen::VectorXd::LinSpaced(N, limits.first, limits.second);
  auto z0 = [&prb](double y) { return prb.z0(y); };
  Eigen::VectorXd zeta = x.unaryExpr(z0);
  Eigen::VectorXd mu = zeta.unaryExpr([&prb](double z) { return prb.g(z); });

  Eigen::VectorXd rhs = semiDiscreteRhs(mu, zeta, prb);

  Eigen::VectorXd rhs_reference(rhs.size());
  rhs_reference << -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0,
      -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0,
      -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0,
      -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0,
      -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0,
      -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0,
      -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0,
      -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0,
      -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0,
      -0, -0, -0, -0, -0, -0, -0, 0.00671849168148503, -1.04094628330866,
      -1.62349853368356, -1.68403731499327, -1.74616278198789,
      -1.80986101309395, -1.87511276244874, -1.94189312221242,
      -2.01017118333682, -2.07990969653901, -2.1510647353689, -2.22358536341845,
      -2.29741330785855, -2.37248264164318, -2.44871947684832,
      -2.52604167175936, -2.60435855442941, -2.6835706655629, -2.76356952366595,
      -2.84423741550769, -2.92544721500658, -3.00706223370967,
      -3.08893610608721, -3.17091271286126, -3.25282614561179,
      -3.33450071584877, -3.41575101171403, -3.49638200536918,
      -3.57618921404886, -3.65495891758707, -3.73246843508994,
      -3.80848646319395, -3.88277347814379, -3.95508220362898,
      -4.02515814604229, -4.09274019845437, -4.15756131426256,
      -4.21934925102943, -4.277827384611, -4.33271559319462, -4.38373121034546,
      -4.42271440227164, -4.40878823829642, -4.44434210743518,
      -4.47520561688257, -4.50113467800314, -4.52188854270804,
      -4.53723068600719, -4.54692971578102, -4.55076031012969,
      -4.54850418261679, -4.53995107571502, -4.5248997825318, -4.50315919668452,
      -4.47454938975236, -4.43890271526358, -4.39606493750934,
      -4.34589638271622, -4.28827310923571, -4.22308809236783,
      -4.15025241837112, -4.06969648097733, -3.98137117251555,
      -3.88524906042273, -3.78132553866294, -3.66961994227746, -3.5501766121323,
      -3.42306589579489, -3.28838506957691, -3.14625916596809,
      -2.99684169019836, -2.84031520933639, -2.67689179738646, -2.5068133201228,
      -2.33035154409382, -2.14780805520973, -1.95951397368408,
      -1.76582945382179, -1.56714295915642, -1.36387030583014,
      -1.15645346971892, -0.945359155718437, -0.731077130675705,
      -0.514118324695956, -0.295012708875602, -0.0743069608564092,
      0.147438067093652, 0.369650059571612, 0.591748108175183,
      0.813145716576269, 1.03325391433549, 1.25148445114203, 1.46725304142668,
      1.67998262802108, 1.88910663273146, 2.09407216136657, 2.29434313097137,
      2.48940328768253, 2.67875908484261, 2.86194239261795, 3.03851301250515,
      3.20806097254849, 3.37020858197123, 3.52461222700456, 3.67096389310556,
      3.8089924022312, 3.93846435752187, 4.05918479136076, 4.17099751646822,
      4.2737851831955, 4.36746904962689, 4.4520084742669, 4.527400144063,
      4.59367705318953, 4.65090725032793, 4.69919237422649, 4.73866599891755,
      4.76949181126846, 4.79186164440491, 4.80599339110292, 4.81212882137449,
      4.81053132835056, 4.80148362602802, 4.78528542173506, 4.76225108508828,
      4.73270733401925, 4.64306713777496, 4.59631275008853, 4.5521666512766,
      4.50307211911884, 4.44935057699408, 4.39132438312428, 4.32931533929206,
      4.26364328190082, 4.19462476060045, 4.12257180860716, 4.04779080785792,
      3.97058145110735, 3.8912358021723, 3.81003745459703, 3.72726078821485,
      3.64317032228542, 3.55802016321466, 3.47205354420872, 3.38550245368722,
      3.29858734876853, 3.21151694975852, 3.12448811120946, 3.03768576486212,
      2.95128292957547, 2.86544078319515, 2.78030879124846, 2.69602488729945,
      2.6127156998414, 2.53049682064671, 2.4494731096192, 2.36973903131549,
      2.29137901849119, 2.21446785820604, 2.13907109625825, 2.06524545593711,
      1.9930392673453, 1.92249290378819, 1.85363922200005, 1.78650400323519,
      1.72110639252424, 1.66075572896416, 1.06718489714462, -0, -0, -0, -0, -0,
      -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0,
      -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0,
      -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0,
      -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0,
      -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0,
      -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0,
      -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0,
      -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0,
      -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0;

  double error = (rhs_reference - rhs).lpNorm<Eigen::Infinity>() / N;
  double tol = 1.0e-3;
  ASSERT_NEAR(0.0, error, tol);
}

TEST(TRFCL, solveCauchyPrb) {
  NonStdCauchyProblemCL prb;
  int M = 500;
  int N = 500;

  Eigen::VectorXd zetaT = solveCauchyPrb(M, N, prb);

  Eigen::VectorXd zetaT_reference(zetaT.size());
  zetaT_reference << 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      1.13961897483011e-08, -2.96843424764734e-06, 8.20926420528625e-07,
      -4.935901890128e-06, -1.62474322211763e-06, 4.68171506324985e-07,
      -4.89971846153118e-06, -8.77700136578923e-06, -8.45032886163758e-06,
      -6.41762536146773e-06, -6.04964770431853e-06, -5.25192862861945e-06,
      5.19285252267852e-06, 1.57898088439803e-07, 3.9670905208574e-06,
      6.17315561706237e-06, 1.86000408965906e-06, 9.34103247996724e-07,
      3.37543199107061e-06, 4.06084887599057e-06, 8.99125818392305e-07,
      -2.10568691750104e-06, -3.68826147802535e-07, -2.41505288489772e-06,
      -1.33393104109716e-05, -1.34425826333637e-05, -9.20752955737752e-06,
      -1.14262258269274e-05, -1.26633495100306e-05, -9.77470900315166e-06,
      -8.60277717756498e-06, -7.41313120481439e-06, 2.86630452003991e-06,
      5.50021221045373e-06, 6.69599353492984e-06, 1.53349398917737e-05,
      1.94770563844435e-05, 1.98314771424361e-05, 1.68637834586684e-05,
      1.73911360962857e-05, 1.78883443748295e-05, 6.11398647084463e-06,
      3.49039493215163e-06, -8.55957889307666e-07, -9.02532525631461e-06,
      -1.69848490689024e-05, -1.78591430223032e-05, -1.6651397752137e-05,
      -1.97196244235968e-05, -2.19478308552892e-05, -1.26794894415524e-05,
      -1.55128838581771e-05, -1.52172451785877e-05, -1.19808943356403e-05,
      3.55101395039807e-06, 4.61982503733719e-06, 1.52830535880993e-05,
      3.79522900429131e-05, 6.2122743424224e-05, 8.77328645706213e-05,
      0.000144711028839868, 0.000207949536415608, 0.000301899410389046,
      0.000423658557777763, 0.000589097676343952, 0.000809925980276729,
      0.00109879337984743, 0.00147131844731435, 0.00194505919328774,
      0.00253870123577673, 0.00327206562544605, 0.00416555902210831,
      0.00523959530233766, 0.00651396225911271, 0.00800717585191872,
      0.00973586510038427, 0.0117142284344776, 0.0139535958829863,
      0.01646212162042, 0.0192446195421311, 0.0223025423471289,
      0.0256340936050984, 0.029234453627316, 0.0330960943017513,
      0.0372091555175816, 0.0415618560815241, 0.0461409145125201,
      0.0509319590548829, 0.0559199109435464, 0.0610893297657262,
      0.0664247142270003, 0.0719107554526086, 0.0775325429956291,
      0.0832757259617306, 0.0891266331570764, 0.0950723570309335,
      0.101100806546679, 0.107200734102774, 0.113361741354896,
      0.119574268358702, 0.125829569935767, 0.132119682619534,
      0.138437385002601, 0.144776153806557, 0.15113011754507, 0.157494009256503,
      0.163863119444762, 0.170233250084026, 0.176600670309611, 0.18296207422794,
      0.189314541127462, 0.195655498253525, 0.201982686218329,
      0.208294127047368, 0.214588094812021, 0.220863088760578,
      0.227117808834102, 0.233351133436513, 0.23956209931829, 0.245749883428438,
      0.251913786588636, 0.258053218845725, 0.264167686363078,
      0.270256779717239, 0.276320163473131, 0.282357566918583, 0.28836877584679,
      0.294353625283177, 0.300311993061049, 0.306243794158009,
      0.312148975712558, 0.318027512647311, 0.323879403831945,
      0.329704668725237, 0.335503344441448, 0.341275483191693,
      0.347021150055997, 0.352740421046335, 0.358433381425224,
      0.364100124248247, 0.369740749102467, 0.375355361015819,
      0.380944069515491, 0.386506987815858, 0.392044232118889,
      0.397555921012002, 0.403042174950224, 0.408503115811131,
      0.413938866512547, 0.419349550684246, 0.424735292386052,
      0.430096215865764, 0.435432445351177, 0.440744104871268,
      0.446031318102309, 0.451294208235209, 0.456532897860962, 0.46174750887147,
      0.466938162373436, 0.472104978613333, 0.477248076911736,
      0.482367575605596, 0.487463591997184, 0.492536242308659,
      0.497585641641372, 0.502611903939114, 0.507615141954679,
      0.512595467219157, 0.517552990013514, 0.522487819342021,
      0.527400062907208, 0.532289827086035, 0.53715721690703, 0.542002336028168,
      0.546825286715302, 0.55162616982099, 0.55640508476355, 0.561162129506237,
      0.565897400536415, 0.570610992844618, 0.575302999903416,
      0.579973513645989, 0.584622624444331, 0.589250421087011, 0.59385699075641,
      0.598442419005367, 0.603006789733161, 0.607550185160768,
      0.612072685805307, 0.616574370453622, 0.621055316134916,
      0.625515598092367, 0.629955289753661, 0.634374462700338, 0.6387731866359,
      0.643151529352571, 0.647509556696636, 0.651847332532257,
      0.656164918703666, 0.660462374995642, 0.664739759092144,
      0.668997126533006, 0.673234530668549, 0.677452022611988,
      0.681649651189506, 0.685827462887823, 0.689985501799123,
      0.694123809563159, 0.698242425306362, 0.702341385577758,
      0.706420724281491, 0.710480472605724, 0.714520658947695,
      0.718541308834657, 0.722542444840449, 0.726524086497381,
      0.730486250203146, 0.734428949122389, 0.738352193082583,
      0.742255988463815, 0.746140338082041, 0.750005241065352,
      0.753850692722747, 0.757676684404858, 0.761483203356044,
      0.765270232557179, 0.769037750558461, 0.772785731301444,
      0.776514143929459, 0.780222952585495, 0.783912116196538,
      0.787581588243249, 0.791231316513755, 0.794861242840213,
      0.798471302816667, 0.802061425496547, 0.805631533067989,
      0.809181540504984, 0.812711355192086, 0.816220876520207, 0.81970999545069,
      0.823178594044578, 0.826626544953535, 0.830053710868535,
      0.833459943921849, 0.836845085037334, 0.84020896322333, 0.843551394801677,
      0.846872182565452, 0.850171114856915, 0.853447964555839,
      0.856702487966819, 0.859934423592174, 0.863143490774614,
      0.866329388190617, 0.869491792171072, 0.87263035481947, 0.875744701888232,
      0.878834430357805, 0.881899105635209, 0.884938258236827,
      0.887951379720157, 0.890937917430006, 0.893897267220018,
      0.896828762476573, 0.899731656036685, 0.902605087953971,
      0.905448024400089, 0.908259136758027, 0.911036555464208,
      0.913777359556375, 0.916476505546032, 0.91912456136636, 0.921702882523788,
      0.92417333207426, 0.926456128780982, 0.928381995921243, 0.929590356986386,
      0.929309935520791, 0.925924435777308, 0.916130088348219, 0.89359083099269,
      0.847468159914002, 0.762687461532975, 0.626051286009163,
      0.442766406770167, 0.254427537370703, 0.1172870520747, 0.0459758493930001,
      0.0165693804247137, 0.00575659277506376, 0.00197201490298456,
      0.00067143229627391, 0.000228229775353917, 7.66275445170637e-05,
      1.47697654768741e-05, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0;

  double error = (zetaT_reference - zetaT).lpNorm<1>() / N;
  double tol = 1.0e-3;
  ASSERT_NEAR(0.0, error, tol);
}

}  // namespace TRFCL::test
